# Pastebin

A Pastebin clone based on the [System Design Primer implementation](https://github.com/donnemartin/system-design-primer/blob/master/solutions/system_design/pastebin/README.md). It allows for shortening of text-based content, and can be deployed to a Kubernetes cluster. For a discussion on the development of this project, see its associated blog post.

## Requirements

Not all of these are hard requirements, but for best results these are the technologies I used:

* .NET 5.0
* Docker Desktop for Windows (4.23.0 (120376))
* Kubernetes (1.27.2)

This program was developed with Docker Desktop as the Kubernetes environment.

## Components

### Shortener

The Shortener service provides an endpoint (`POST /shorten`) that allows users to submit custom content in exchange for a 7-character "shortlink" that can be shared and submitted to the Lengthener service to obtain the original content. An optional expiry timer can be set indicating the lifetime of the shortlink, in minutes after creation. If omitted, the default expiry time is 60 minutes.

Requests to the Shortener service look like this:

```http request
POST http://localhost:5000/shorten
Accept: application/json
Content-Type: application/json

{
  "content": "80-minute expiration",
  "expires": 80
}
```

```http request
POST http://localhost:5000/shorten
Accept: application/json
Content-Type: application/json

{
  "content": "default expiration (60 minutes)"
}
```

Shortlink responses look like this:

```json
{
  "shortlink": "ItLwElS"
}
```

If you're having trouble connecting to or deploying the database, you can switch to the `EchoShortener` class to confirm that everything works.

### Lengthener

The Lengthener service provides an endpoint (`GET /lengthen/{shortlink}`) that accepts shortlinks generated by the Shortener service and returns the content associated with that shortlink. If the content has expired, then a `410 Gone` response will be returned instead.

Lengthening requests look like this:

```http request
GET http://localhost:5002/lengthen/ItLwElS
Accept: application/json
```

Content responses look like this:

```json
{
  "content": "80-minute expiration",
  "created": "2023-09-24 12:33:50",
  "expires": 80
}
```

Similar to the Shortlink service, an `EchoStore` class has been provided to confirm the functionality of the service without a database.

### Database

A SQL Server (2019) database configuration has been provided. Makefile targets for containerizing and running a database instance have also been provided. Note that I haven't tested running the database as a standalone container (only within the Kubernetes cluster), so some extra configuration may be needed.

If you're running the database locally, you would need to change the default connection string in each of the `appsettings.json` files. They are currently set to my own local database.

## Deployment

This program may be run in several different ways: locally, in Docker containers, or in a Kubernetes cluster, however the main goal for this project was getting it to run in a Kubernetes cluster.

The root [Makefile](Makefile) provides several targets for building, running, and managing your Kubernetes cluster. To build and run the program, use the following targets (in order):

```shell
make docker/build
make k8s/pastebin/apply
```

If you're using Docker Desktop as your Kubernetes environment, you will need to install an ingress controller in order for the Ingress resource to be accessible. The following target has been provided to do this:

```shell
make k8s/ingress/apply
```

You can use the `k8s/pastebin/check` target to confirm the status of your deployment, and to get the address of the Ingress. However, if you're using WSL2 on Windows, then the reported address may not be correct. To find the IP address of your service, you may need to go inside the WSL virtual machine as described in [this StackOverflow answer](https://stackoverflow.com/a/69113528).

## Future Work

This project was meant as an exercise in messing around with Kubernetes, and many of the features outlined in the System Design Primer solution were omitted (user registration, visibility, custom shortlinks, automatic deletion, metrics tracking, caching) so I could focus on that. I definitely plan to revisit this project in the future since there's still so many technologies I'd like to experiment with (caching with MemoryCache/Redis/Memcached, MongoDB as a data store, S3 for object storage, centralized logging, CI/CD, deploying to cloud), but for now I'd like to publish what I have.
